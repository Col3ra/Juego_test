<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Amigos Kombat</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            background-color: #121212;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Press Start 2P', cursive;
            color: white;
        }

        /* Contenedor principal */
        #game-container {
            position: relative;
            width: 100%;
            max-width: 1024px;
            aspect-ratio: 16/9;
            background: black;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        /* --- INTERFAZ DE BATALLA --- */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            pointer-events: none;
            z-index: 10;
            display: none; /* Se oculta en el menú */
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .health-wrapper {
            display: flex;
            flex-direction: column;
            width: 42%;
        }

        .player-name {
            font-size: 12px;
            margin-bottom: 5px;
            text-shadow: 2px 2px black;
        }

        .health-bar-container {
            position: relative;
            width: 100%;
            height: 30px;
            background: #333;
            border: 3px solid #fff;
        }

        .health-bar {
            position: absolute;
            top: 0;
            height: 100%;
            background: #4ade80;
            transition: width 0.3s ease-out;
        }

        /* P1 Salud: Izquierda a derecha (default) */
        #playerHealth { left: 0; }
        /* P2 Salud: Derecha a izquierda */
        #enemyHealth { right: 0; background: #f87171; }

        .timer {
            width: 50px;
            height: 50px;
            background: #222;
            border: 3px solid #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
        }

        .overlay-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 50px;
            display: none;
            z-index: 20;
            text-shadow: 4px 4px 0 #000, -2px -2px 0 #555;
            text-align: center;
            width: 100%;
        }

        .restart-hint {
            font-size: 12px;
            margin-top: 20px;
            animation: blink 1s infinite;
            display: block;
        }

        @keyframes blink { 50% { opacity: 0; } }

        /* --- PANTALLA DE SELECCIÓN --- */
        #character-select {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #1a1a2e, #16213e);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #character-select h2 {
            margin-bottom: 10px;
            font-size: 24px;
            text-align: center;
            color: #e94560;
            text-shadow: 2px 2px 0 #000;
        }
        
        .selection-step {
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            color: #aaa;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            max-width: 500px;
            width: 100%;
        }

        .char-card {
            background: rgba(255,255,255,0.1);
            border: 3px solid #444;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .char-card:hover, .char-card.selected {
            background: rgba(255,255,255,0.2);
            border-color: #e94560;
            transform: scale(1.05);
        }

        .char-preview {
            width: 50px;
            height: 50px;
            background-repeat: no-repeat;
            /* Hacemos zoom al sprite para mostrar la cara */
            background-size: 400%; 
            background-position: 0 0;
            image-rendering: pixelated;
            margin-bottom: 10px;
        }

        /* --- CONTROLES TÁCTILES --- */
        #mobile-controls {
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 100%;
            height: 140px;
            display: none; /* JS activará esto si es touch */
            pointer-events: none;
            z-index: 50;
            padding: 0 20px;
        }

        .control-group {
            pointer-events: auto;
            display: flex;
            gap: 15px;
        }

        .left-controls { position: absolute; bottom: 20px; left: 20px; }
        .right-controls { position: absolute; bottom: 20px; right: 20px; }

        .btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            backdrop-filter: blur(2px);
        }

        .btn:active { background: rgba(255, 255, 255, 0.4); }
        .btn-big { width: 75px; height: 75px; background: rgba(233, 69, 96, 0.3); border-color: #e94560; }

        @media (max-width: 768px) {
            .player-name { font-size: 9px; }
            .health-bar-container { height: 15px; border-width: 2px; }
            .timer { width: 35px; height: 35px; font-size: 14px; border-width: 2px; }
            #character-select h2 { font-size: 16px; }
            .grid { gap: 10px; }
        }
    </style>
</head>
<body>

    <div id="game-container">
        <!-- PANTALLA DE SELECCIÓN -->
        <div id="character-select">
            <h2>ELIGE TU LUCHADOR</h2>
            <p class="selection-step" id="select-instruction">Jugador 1: Selecciona personaje</p>
            <div class="grid" id="char-grid">
                <!-- Se llena con JS -->
            </div>
        </div>

        <!-- HUD JUEGO -->
        <div class="ui-layer" id="game-ui">
            <div class="top-bar">
                <!-- P1 -->
                <div class="health-wrapper">
                    <div class="player-name" id="p1-name">JUGADOR 1</div>
                    <div class="health-bar-container">
                        <div class="health-bar" id="playerHealth"></div>
                    </div>
                </div>
                
                <!-- Timer -->
                <div class="timer" id="timer">60</div>

                <!-- P2 -->
                <div class="health-wrapper" style="align-items: flex-end;">
                    <div class="player-name" id="p2-name">JUGADOR 2</div>
                    <div class="health-bar-container">
                        <div class="health-bar" id="enemyHealth"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESULTADO FINAL -->
        <div class="overlay-text" id="displayText">
            <span id="winnerText">GANADOR</span>
            <span class="restart-hint">Toca para reiniciar</span>
        </div>

        <!-- CANVAS -->
        <canvas id="canvas"></canvas>

        <!-- CONTROLES MÓVILES -->
        <div id="mobile-controls">
            <div class="left-controls control-group">
                <div class="btn" id="btn-left">←</div>
                <div class="btn" id="btn-right">→</div>
            </div>
            <div class="right-controls control-group">
                <div class="btn btn-big" id="btn-attack">⚔️</div>
                <div class="btn" id="btn-jump">↑</div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN DE PERSONAJES ---
        const CHARACTERS = {
            juan: {
                name: "Juan",
                color: "#4ade80", // Verde
                imgSrc: "http://googleusercontent.com/generated_image_content/0",
                scale: 3.5,
                offset: { x: 120, y: 100 }
            },
            fran: {
                name: "Fran",
                color: "#ffffff", // Blanco
                imgSrc: "http://googleusercontent.com/generated_image_content/1",
                scale: 3.5,
                offset: { x: 120, y: 100 }
            },
            fede: {
                name: "Fede",
                color: "#60a5fa", // Azul
                imgSrc: "http://googleusercontent.com/generated_image_content/2",
                scale: 3.5,
                offset: { x: 120, y: 100 }
            },
            rodri: {
                name: "Rodri",
                color: "#a78bfa", // Violeta
                imgSrc: "http://googleusercontent.com/generated_image_content/3",
                scale: 3.5,
                offset: { x: 120, y: 100 }
            }
        };

        const canvas = document.querySelector('canvas');
        const c = canvas.getContext('2d');
        
        // Configurar resolución interna
        canvas.width = 1024;
        canvas.height = 576;

        const gravity = 0.8;

        // --- CLASES ---

        class Sprite {
            constructor({ position, imageSrc, scale = 1, framesMax = 1, offset = { x: 0, y: 0 } }) {
                this.position = position;
                this.width = 50;
                this.height = 150;
                this.image = new Image();
                this.image.src = imageSrc;
                this.scale = scale;
                this.framesMax = framesMax;
                this.framesCurrent = 0;
                this.framesElapsed = 0;
                this.framesHold = 8;
                this.offset = offset;
                this.rows = 5; // Sprite sheet rows
                this.currentRow = 0; 
            }

            draw() {
                const frameWidth = this.image.width / this.framesMax;
                const frameHeight = this.image.height / this.rows;

                c.drawImage(
                    this.image,
                    this.framesCurrent * frameWidth,
                    this.currentRow * frameHeight,
                    frameWidth,
                    frameHeight,
                    this.position.x - this.offset.x,
                    this.position.y - this.offset.y,
                    (frameWidth) * this.scale,
                    (frameHeight) * this.scale
                );
            }

            animateFrames() {
                this.framesElapsed++;
                if (this.framesElapsed % this.framesHold === 0) {
                    if (this.framesCurrent < this.framesMax - 1) {
                        this.framesCurrent++;
                    } else {
                        this.framesCurrent = 0;
                    }
                }
            }

            update() {
                this.draw();
                this.animateFrames();
            }
        }

        class Fighter extends Sprite {
            constructor({
                position,
                velocity,
                color = 'red',
                imageSrc,
                scale = 1,
                framesMax = 1,
                offset = { x: 0, y: 0 },
                sprites,
                attackBox = { offset: {}, width: undefined, height: undefined },
                name
            }) {
                super({ position, imageSrc, scale, framesMax, offset });

                this.velocity = velocity;
                this.width = 50;
                this.height = 150;
                this.lastKey;
                this.attackBox = {
                    position: { x: this.position.x, y: this.position.y },
                    offset: attackBox.offset,
                    width: attackBox.width,
                    height: attackBox.height
                };
                this.color = color;
                this.isAttacking = false;
                this.health = 100;
                this.framesCurrent = 0;
                this.framesElapsed = 0;
                this.framesHold = 6;
                this.sprites = sprites;
                this.dead = false;
                this.name = name;

                // Mapeo de spritesheet único
                for (const sprite in this.sprites) {
                    this.sprites[sprite].image = new Image();
                    this.sprites[sprite].image.src = imageSrc;
                }
            }

            update() {
                this.draw();
                if (!this.dead) this.animateFrames();

                // Attack Box
                this.attackBox.position.x = this.position.x + this.attackBox.offset.x;
                this.attackBox.position.y = this.position.y + this.attackBox.offset.y;

                // Física
                this.position.x += this.velocity.x;
                this.position.y += this.velocity.y;

                // Gravedad y Suelo
                if (this.position.y + this.height + this.velocity.y >= canvas.height - 96) {
                    this.velocity.y = 0;
                    this.position.y = 330; 
                } else {
                    this.velocity.y += gravity;
                }

                // Límites de pantalla
                if (this.position.x < 0) this.position.x = 0;
                if (this.position.x + this.width > canvas.width) this.position.x = canvas.width - this.width;
            }

            attack() {
                this.switchSprite('attack1');
                this.isAttacking = true;
            }

            takeHit() {
                this.health -= 10;
                if (this.health <= 0) {
                    this.switchSprite('death');
                } else {
                    this.switchSprite('takeHit');
                }
            }

            switchSprite(sprite) {
                if (this.image === this.sprites.death.image) {
                    if (this.framesCurrent === this.sprites.death.framesMax - 1) this.dead = true;
                    return;
                }
                if (this.image === this.sprites.attack1.image && this.framesCurrent < this.sprites.attack1.framesMax - 1) return;
                if (this.image === this.sprites.takeHit.image && this.framesCurrent < this.sprites.takeHit.framesMax - 1) return;

                switch (sprite) {
                    case 'idle':
                        if (this.image !== this.sprites.idle.image) {
                            this.image = this.sprites.idle.image;
                            this.framesMax = this.sprites.idle.framesMax;
                            this.currentRow = 0;
                            this.framesCurrent = 0;
                        }
                        break;
                    case 'run':
                        if (this.image !== this.sprites.run.image) {
                            this.image = this.sprites.run.image;
                            this.framesMax = this.sprites.run.framesMax;
                            this.currentRow = 1;
                            this.framesCurrent = 0;
                        }
                        break;
                    case 'attack1':
                        if (this.image !== this.sprites.attack1.image) {
                            this.image = this.sprites.attack1.image;
                            this.framesMax = this.sprites.attack1.framesMax;
                            this.currentRow = 2;
                            this.framesCurrent = 0;
                        }
                        break;
                    case 'takeHit':
                        if (this.image !== this.sprites.takeHit.image) {
                            this.image = this.sprites.takeHit.image;
                            this.framesMax = this.sprites.takeHit.framesMax;
                            this.currentRow = 4;
                            this.framesCurrent = 0;
                        }
                        break;
                    case 'death':
                        if (this.image !== this.sprites.death.image) {
                            this.image = this.sprites.death.image;
                            this.framesMax = this.sprites.death.framesMax;
                            this.currentRow = 4;
                            this.framesCurrent = 0;
                        }
                        break;
                }
            }
        }

        // --- GLOBAL VARIABLES ---
        let player, enemy;
        let timer = 60;
        let timerId;
        let gameRunning = false;

        const keys = {
            a: { pressed: false },
            d: { pressed: false },
            ArrowRight: { pressed: false },
            ArrowLeft: { pressed: false }
        };

        // --- UI & SELECTION LOGIC ---
        
        let p1Selection = null;
        let p2Selection = null;

        function initSelectionScreen() {
            const grid = document.getElementById('char-grid');
            grid.innerHTML = '';

            Object.keys(CHARACTERS).forEach(key => {
                const char = CHARACTERS[key];
                const card = document.createElement('div');
                card.className = 'char-card';
                card.innerHTML = `
                    <div class="char-preview" style="background-image: url('${char.imgSrc}')"></div>
                    <span>${char.name}</span>
                `;
                card.onclick = () => selectCharacter(key);
                grid.appendChild(card);
            });
        }

        function selectCharacter(key) {
            if (!p1Selection) {
                p1Selection = key;
                document.getElementById('select-instruction').innerText = "Jugador 2: Selecciona Oponente";
                document.getElementById('select-instruction').style.color = "#f87171";
            } else {
                p2Selection = key;
                document.getElementById('character-select').style.display = 'none';
                startGame(p1Selection, p2Selection);
            }
        }

        function startGame(p1Key, p2Key) {
            const p1Data = CHARACTERS[p1Key];
            const p2Data = CHARACTERS[p2Key];

            // UI Updates
            document.getElementById('game-ui').style.display = 'flex';
            document.getElementById('p1-name').innerText = p1Data.name;
            document.getElementById('p2-name').innerText = p2Data.name;
            
            // Create Players
            player = new Fighter({
                position: { x: 100, y: 0 },
                velocity: { x: 0, y: 0 },
                offset: { x: 0, y: 0 },
                imageSrc: p1Data.imgSrc,
                framesMax: 4,
                scale: p1Data.scale,
                offset: p1Data.offset,
                sprites: {
                    idle: { framesMax: 4 },
                    run: { framesMax: 6 },
                    attack1: { framesMax: 3 },
                    takeHit: { framesMax: 3 },
                    death: { framesMax: 3 }
                },
                attackBox: { offset: { x: 100, y: 50 }, width: 160, height: 50 },
                name: p1Data.name
            });

            enemy = new Fighter({
                position: { x: 800, y: 0 },
                velocity: { x: 0, y: 0 },
                color: 'blue',
                offset: { x: -50, y: 0 },
                imageSrc: p2Data.imgSrc,
                framesMax: 4,
                scale: p2Data.scale,
                offset: p2Data.offset,
                sprites: {
                    idle: { framesMax: 4 },
                    run: { framesMax: 6 },
                    attack1: { framesMax: 3 },
                    takeHit: { framesMax: 3 },
                    death: { framesMax: 3 }
                },
                attackBox: { offset: { x: -170, y: 50 }, width: 170, height: 50 },
                name: p2Data.name
            });

            // Reset Stats
            player.health = 100;
            enemy.health = 100;
            document.getElementById('playerHealth').style.width = '100%';
            document.getElementById('enemyHealth').style.width = '100%';
            
            timer = 60;
            gameRunning = true;
            document.getElementById('displayText').style.display = 'none';
            
            decreaseTimer();
            animate();

            // Show controls if touch
            if('ontouchstart' in window || navigator.maxTouchPoints > 0){
                document.getElementById('mobile-controls').style.display = 'block';
            }
        }

        // --- GAME LOOP ---

        function rectangularCollision({ rectangle1, rectangle2 }) {
            return (
                rectangle1.attackBox.position.x + rectangle1.attackBox.width >= rectangle2.position.x &&
                rectangle1.attackBox.position.x <= rectangle2.position.x + rectangle2.width &&
                rectangle1.attackBox.position.y + rectangle1.attackBox.height >= rectangle2.position.y &&
                rectangle1.attackBox.position.y <= rectangle2.position.y + rectangle2.height
            );
        }

        function determineWinner({ player, enemy, timerId }) {
            clearTimeout(timerId);
            document.querySelector('#displayText').style.display = 'flex';
            const resultText = document.querySelector('#winnerText');
            
            if (player.health === enemy.health) {
                resultText.innerText = 'EMPATE';
            } else if (player.health > enemy.health) {
                resultText.innerText = player.name + ' GANA';
            } else {
                resultText.innerText = enemy.name + ' GANA';
            }
            
            gameRunning = false;
        }

        function decreaseTimer() {
            if (timer > 0) {
                timerId = setTimeout(decreaseTimer, 1000);
                timer--;
                document.querySelector('#timer').innerHTML = timer;
            }

            if (timer === 0) {
                determineWinner({ player, enemy, timerId });
            }
        }

        function animate() {
            if(!gameRunning) return;
            
            window.requestAnimationFrame(animate);
            
            // Clear & BG
            c.fillStyle = 'black';
            c.fillRect(0, 0, canvas.width, canvas.height);
            
            // Simple Stage Gradient
            let gradient = c.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, "#1a1a2e");
            gradient.addColorStop(1, "#16213e");
            c.fillStyle = gradient;
            c.fillRect(0, 0, canvas.width, canvas.height);
            
            // Floor
            c.fillStyle = '#0f0f0f';
            c.fillRect(0, canvas.height - 96, canvas.width, 96);
            c.fillStyle = '#222';
            c.fillRect(0, canvas.height - 96, canvas.width, 10); // linea detalle piso

            // Render Characters
            c.fillStyle = 'rgba(255,255,255,0.02)'; // Ambiente
            c.fillRect(0,0,canvas.width, canvas.height);

            player.update();
            enemy.update();

            // --- MOVEMENT LOGIC ---
            
            // P1
            player.velocity.x = 0;
            if (keys.a.pressed && player.lastKey === 'a') {
                player.velocity.x = -5;
                player.switchSprite('run');
            } else if (keys.d.pressed && player.lastKey === 'd') {
                player.velocity.x = 5;
                player.switchSprite('run');
            } else {
                player.switchSprite('idle');
            }

            if (player.velocity.y < 0) { /* Jumping */ }

            // P2 (Simple CPU AI + Keyboard override)
            enemy.velocity.x = 0;
            
            // Basic AI: Move towards player if far
            const dist = Math.abs(player.position.x - enemy.position.x);
            
            if (keys.ArrowLeft.pressed && enemy.lastKey === 'ArrowLeft') {
                enemy.velocity.x = -5;
                enemy.switchSprite('run');
            } else if (keys.ArrowRight.pressed && enemy.lastKey === 'ArrowRight') {
                enemy.velocity.x = 5;
                enemy.switchSprite('run');
            } else {
                enemy.switchSprite('idle');
            }

            // Colisiones P1 -> P2
            if (
                rectangularCollision({ rectangle1: player, rectangle2: enemy }) &&
                player.isAttacking &&
                player.framesCurrent === 1
            ) {
                enemy.takeHit();
                player.isAttacking = false;
                document.querySelector('#enemyHealth').style.width = enemy.health + '%';
            }

            // Miss detection
            if (player.isAttacking && player.framesCurrent === 1) player.isAttacking = false;

            // Colisiones P2 -> P1
            if (
                rectangularCollision({ rectangle1: enemy, rectangle2: player }) &&
                enemy.isAttacking &&
                enemy.framesCurrent === 1
            ) {
                player.takeHit();
                enemy.isAttacking = false;
                document.querySelector('#playerHealth').style.width = player.health + '%';
            }

            if (enemy.isAttacking && enemy.framesCurrent === 1) enemy.isAttacking = false;

            // End Game Check
            if (enemy.health <= 0 || player.health <= 0) {
                determineWinner({ player, enemy, timerId });
            }
        }

        // --- INPUT HANDLERS ---

        window.addEventListener('keydown', (event) => {
            if(!player || player.dead || !gameRunning) return;

            switch (event.key) {
                case 'd': keys.d.pressed = true; player.lastKey = 'd'; break;
                case 'a': keys.a.pressed = true; player.lastKey = 'a'; break;
                case 'w': player.velocity.y = -15; break;
                case ' ': player.attack(); break;
                
                // P2 Controls
                case 'ArrowRight': keys.ArrowRight.pressed = true; enemy.lastKey = 'ArrowRight'; break;
                case 'ArrowLeft': keys.ArrowLeft.pressed = true; enemy.lastKey = 'ArrowLeft'; break;
                case 'ArrowUp': enemy.velocity.y = -15; break;
                case 'ArrowDown': enemy.attack(); break;
            }
        });

        window.addEventListener('keyup', (event) => {
            switch (event.key) {
                case 'd': keys.d.pressed = false; break;
                case 'a': keys.a.pressed = false; break;
                case 'ArrowRight': keys.ArrowRight.pressed = false; break;
                case 'ArrowLeft': keys.ArrowLeft.pressed = false; break;
            }
        });

        // Reinicio al tocar pantalla si terminó
        window.addEventListener('click', () => {
            if(!gameRunning && player) {
                location.reload();
            }
        });
        
        window.addEventListener('touchstart', () => {
            if(!gameRunning && player) {
                location.reload();
            }
        });

        // --- TOUCH CONTROLS ---
        const btnLeft = document.getElementById('btn-left');
        const btnRight = document.getElementById('btn-right');
        const btnJump = document.getElementById('btn-jump');
        const btnAttack = document.getElementById('btn-attack');

        function addTouchListener(elem, code, type) {
            elem.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if(!gameRunning) return;
                
                if (type === 'move') {
                    keys[code].pressed = true;
                    player.lastKey = code;
                } else if (type === 'jump') {
                    player.velocity.y = -15;
                } else if (type === 'attack') {
                    player.attack();
                }
            }, { passive: false });

            elem.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (type === 'move') {
                    keys[code].pressed = false;
                }
            });
        }

        addTouchListener(btnLeft, 'a', 'move');
        addTouchListener(btnRight, 'd', 'move');
        addTouchListener(btnJump, 'w', 'jump');
        addTouchListener(btnAttack, 'space', 'attack');

        // Inicializar menú
        initSelectionScreen();

    </script>
</body>
</html>


